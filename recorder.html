
<!DOCTYPE html>
<html lang="ja">

<head>
    <title>リコーダー練習中</title>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Script-Type" content="text/javascript">
    <style type="text/css">

        .hole{
            display: inline-block;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            background-color: #000000;
            border: #888888 solid 3px;
            font-size: 36px;             
        }

        .rights{
            display: inline;
            text-align: left;
        }

        .lefts{
            display: inline;
            float: right;
        }

        .inner{
            margin-left: 10px;
        }
       
        body {
            background-color: #ffffcc ;
            -webkit-user-select:none; 
        }

   </style>

</head>



<body>
    <h3>リコーダー練習中</h3>
    <div>
        タブレットを両手で持ち、リコーダーの穴のように○を押さえてみよう<br>

    </div>
    <div class="main">
        <div>
            <p>
                音量
            </p>
            <p>
                <input type="range" min="0" max="5" step="0.01" value="3" id="level"  value="1" />
            </p>
            <p id="leveldisp">
                3
            </p>
        </div>
        <div id="holes">
            <div class="lefts">
                <div>（左手）</div>
                <div id="left1" class="hole"></div>
                <br>
                <div id="left2" class="hole"></div>
                <br>
                <div id="left3" class="hole"></div>
            </div>
            <div class="rights">
                <div>（右手）</div>                
                <div id="right1" class="hole inner"></div>
                <br>
                <div id="right2" class="hole inner"></div>
                <br>
                <div id="right3" class="hole inner"></div>
                <br>
                <div id="right4" class="hole"></div>
            </div>           
        </div>
        <div>
            <br><br><br><br>
            <input type="button"  value="リセット（壊れたらこのボタンを押す）" id="reload">            
        </div>
        <script>
            const holes = document.getElementById("holes")
            const left1 = document.getElementById("left1")
            const left2 = document.getElementById("left2")
            const left3 = document.getElementById("left3")
            const right1 = document.getElementById("right1")
            const right2 = document.getElementById("right2")
            const right3 = document.getElementById("right3")
            const right4 = document.getElementById("right4")

            let level = 3;

            let osc;
            let stopping = true;

            holes.addEventListener("touchstart", function() {
                updateHolesInfo(event)
            })
            holes.addEventListener("touchend", function() {
                updateHolesInfo(event)
            })
            holes.addEventListener("touchcancel", function() {
                updateHolesInfo(event)
            })

            // タッチされた指の一覧の配列を作る
            function updateHolesInfo(event) {
              const touchList = event.touches;
              let touchedHole = [];
              for (let touch of touchList) {
                  touchedHole.push(touch.target.id);
              }

              const l1 = touchedHole.includes("left1");
              const l2 = touchedHole.includes("left2");
              const l3 = touchedHole.includes("left3");
              const r1 = touchedHole.includes("right1");
              const r2 = touchedHole.includes("right2");
              const r3 = touchedHole.includes("right3");
              const r4 = touchedHole.includes("right4");

              if (false) {
                //
              } else if ( l1 &&  l2 &&  l3 &&  r1 &&  r2 &&  r3 &&  r4) {
                  updateOrStartWithFreq(261.626); //ド
              } else if ( l1 &&  l2 &&  l3 &&  r1 &&  r2 &&  r3 && !r4) {
                  updateOrStartWithFreq(293.665); //レ
              } else if ( l1 &&  l2 &&  l3 &&  r1 &&  r2 && !r3 && !r4) {
                  updateOrStartWithFreq(329.628); //ミ
              } else if ( l1 &&  l2 &&  l3 &&  r1 && !r2 && !r3 && !r4) {
                  updateOrStartWithFreq(349.228); //ファ
              } else if ( l1 &&  l2 &&  l3 && !r1 &&  r2 &&  r3 &&  r4) {
                  updateOrStartWithFreq(369.994); //♯ファ
              } else if ( l1 &&  l2 &&  l3 && !r1 && !r2 && !r3 && !r4) {
                  updateOrStartWithFreq(391.995); //ソ
              } else if ( l1 &&  l2 && !l3 && !r1 && !r2 && !r3 && !r4) {
                  updateOrStartWithFreq(440.000); //ラ
              } else if ( l1 && !l2 &&  l3 &&  r1 && !r2 && !r3 && !r4) {
                  updateOrStartWithFreq(466.164); //♭シ
              } else if ( l1 && !l2 && !l3 && !r1 && !r2 && !r3 && !r4) {
                  updateOrStartWithFreq(493.883); //シ
              } else if (!l1 &&  l2 && !l3 && !r1 && !r2 && !r3 && !r4) {
                  updateOrStartWithFreq(523.251); //ド
              } else {
                  stop();
              }
          }

            function updateOrStartWithFreq(freq) {
              // なっているときは一旦音を止める
              stop();

              window.AudioContext = window.AudioContext || window.webkitAudioContext; // for legacy browsers	
              const ctx = new AudioContext();
              ctx.createGain = ctx.createGain || ctx.createGainNode;
              const gain = ctx.createGain();
              osc = ctx.createOscillator();
              osc.connect(gain);
              gain.connect(ctx.destination);

              osc.start = osc.start || osc.noteOn;
              gain.gain.value = level;
              osc.frequency.value = freq;

              osc.start(0);
              stopping = false;
            }

            function stop() {
                if (stopping == false) {
                    osc.stop = osc.stop || osc.noteOff; // for legacy browsers
                    osc.stop(0); // 音を止める
                    stopping = true;
                }
            }

            function setupLevel() {
                level = parseFloat(document.getElementById("level").value);
                document.getElementById("leveldisp").innerHTML = level;
            }

            document.getElementById("level").addEventListener("input", setupLevel);
       
            document.getElementById("reload").addEventListener('click', function(){
                location.reload();
            })
         </script>

    </div>

</body>

</html>
